<div id="treeView" style="background-color:#FAFAFA; width:350px;"></div>
<script type="text/javascript">
/*<![CDATA[*/
(function(){	
	function ExtendedTreeView(config) {
		ExtendedTreeView.superclass.constructor.apply(this, arguments);
	}
	ExtendedTreeView.NAME = "extendedtreeview";
	YAHOO.extend(ExtendedTreeView, YAHOO.widget.TreeView, {
		expandedNodes: [],
		setExpandedNodes: function(nodes) {
			this.expandedNodes = nodes;
			return this;
		},
		getExpandedNodes: function() {
			return this.expandedNodes;
		},
		expandCertainNodes: function(nodes) {
			this.setExpandedNodes(nodes);
			this.rEpandNodes(this.getRoot());
		},
		rEpandNodes: function(node) {
			length = node.children.length;
			for (var i = 0; i < length; ++i) {
				var c = node.children[i];
				if (this.isNodeExpanded(c)) {
					c.expand();
				}
				this.rEpandNodes(c);		
			}
		},
		isNodeExpanded: function(node) {
			length = this.getExpandedNodes().length;
			for (var i = 0; i < length; ++i) {
				if (MD5(node.html) == this.getExpandedNodes()[i]) {
					return true;
				}
			}
			
			return false;
		}
	});
		
	//create the TreeView instance:
	tree = new ExtendedTreeView("treeView");
	tree.subscribe("expand", function(node) {
		found = false;
		length = this.getExpandedNodes().length;
		for (var i = 0; i < length; ++i) {
			if (this.getExpandedNodes()[i] == MD5(node.html)) {
				found = true;
				break;
			}
		}		
		if (!found) {			
			this.getExpandedNodes().push(MD5(node.html));
			ilFrmTreeStateHandler.call(this);
			//console.log(this.getExpandedNodes());
		}
	});	 
	tree.subscribe("collapse", function(node) {
		tmp = [];
		length = this.getExpandedNodes().length;
		for (var i = 0; i < length; ++i) {
			if (this.getExpandedNodes()[i] != MD5(node.html)) {
				tmp.push(this.getExpandedNodes()[i]);
			}
		}
		this.setExpandedNodes(tmp);
		ilFrmTreeStateHandler.call(this);
		//console.log(this.getExpandedNodes());
	});
	
	function ilFrmTreeStateHandler()
	{
		var ilFrmTreeStateCallback =
		{
			success: function(o) {				
			},
			failure: function(o) {
			}
		};
		
		var parameters = 'openNodes=' + this.getExpandedNodes();
		var request = YAHOO.util.Connect.asyncRequest('POST', "{THR_TREE_STATE_URL}", ilFrmTreeStateCallback, parameters);
		
		return false;
	}
	
	//get a reference to the root node; all
	//top level nodes are children of the root node:
	var rootNode = tree.getRoot()
	
	//begin adding children
	var nodeHTML = "{FRM_TREE_ROOT_NODE_LINK}{FRM_TREE_ROOT_NODE_AUTHOR_AND_DATE}";
	var {FRM_TREE_ROOT_NODE_VARIABLE} = new YAHOO.widget.HTMLNode(nodeHTML, tree.getRoot(), false, true);<!-- BEGIN frm_nodes -->
	var nodeHTML = "{FRM_NODES_LINK}{FRM_NODES_AUTHOR_AND_DATE}";
	var {FRM_NODES_VARNAME} = new YAHOO.widget.HTMLNode(nodeHTML, {FRM_NODES_PARENT_VARNAME}, false, true);
	<!-- END frm_nodes -->

	//the tree won't show up until you draw (render) it:
	tree.draw();

//	if ({THR_OPEN_NODES}.length == 0 || {OLD_THR_ID} != {NEW_THR_ID})
		tree.expandAll();
		
//	else
//		tree.expandCertainNodes({THR_OPEN_NODES});


})();
/*]]>*/
</script>