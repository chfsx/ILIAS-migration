<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <meta http-equiv="content-type" content="application/xhtml+xml; charset=utf-8" />
    <meta name="author" content="Helmut SchottmÃ¼ller" />
    <meta name="generator" content="JEdit" />
		<title>{$lang_latex_desc}</title>
		<script language="javascript" type="text/javascript" src="../../tiny_mce_popup.js"></script>
		<script language="javascript" type="text/javascript" src="../../utils/mctabs.js"></script>
		<script language="javascript" type="text/javascript" src="../../utils/form_utils.js"></script>
		<link href="css/latex.css" rel="stylesheet" type="text/css" />
		<base target="_self" />
		<script language="javascript" type="text/javascript">
			function latexCodeChanged()
			{
				var image = document.getElementById("preview");
				var textarea = document.getElementById("latex_code");
				if (textarea.value.length == 0)
				{
					image.setAttribute("src", '{HREF_LATEX_CONVERTER}');
				}
				else
				{
					image.setAttribute("src", "{HREF_LATEX_CONVERTER}?" + encodeURIComponent(textarea.value));
				}
			}
			
			function insertAction() 
			{
				var inst = tinyMCE.getInstanceById(tinyMCE.getWindowArg('editor_id'));
				var elm = inst.getFocusElement();
				elm = tinyMCE.getParentElement(elm, "span");
				tinyMCEPopup.execCommand("mceBeginUndoLevel");
				var latex_code = document.getElementById("latex_code").value;
				if (latex_code.length > 0)
				{
					if (elm == null) 
					{
						tinyMCEPopup.execCommand("mceInsertContent", false, '<span class="latex">' + latex_code + '</span>');
					} 
					else
					{
						elm.innerHTML = "";
						tinyMCE.execCommand("mceRemoveNode", false, elm);
						tinyMCEPopup.execCommand("mceInsertContent", false, '<span class="latex">' + latex_code + '</span>');
					}
				}

				tinyMCE._setEventsEnabled(inst.getBody(), false);
				tinyMCEPopup.execCommand("mceEndUndoLevel");
				tinyMCEPopup.close();
			}
			
			function insertImageAction() 
			{
				var inst = tinyMCE.getInstanceById(tinyMCE.getWindowArg('editor_id'));
				var elm = inst.getFocusElement();
				elm = tinyMCE.getParentElement(elm, "img");
				tinyMCEPopup.execCommand("mceBeginUndoLevel");
				var latex_code = document.getElementById("latex_code").value;
				var url = "{HREF_LATEX_CONVERTER}?" + encodeURIComponent(latex_code);
				if (latex_code.length > 0)
				{
					// Create new anchor elements
					if (elm == null) 
					{
						tinyMCEPopup.execCommand("mceInsertContent", false, '<img id="latex" src="' + url + '" />');
					} 
					else
					{
						elm.setAttribute("src", url);
					}
				}

				tinyMCE._setEventsEnabled(inst.getBody(), false);
				tinyMCEPopup.execCommand("mceEndUndoLevel");
				tinyMCEPopup.close();
			}
			
			function init()
			{
				var inst = tinyMCE.getInstanceById(tinyMCE.getWindowArg('editor_id'));
				var elm = inst.getFocusElement();
				elm = tinyMCE.getParentElement(elm, "span");
				if (elm != null)
				{
					var id = elm.getAttribute("class");
					if (id == "latex")
					{
						var textarea = document.getElementById("latex_code");
						var text = "";
						for (i = 0; i < elm.childNodes.length; i++)
						{
							text = text + elm.childNodes[i].data;
						}
						textarea.value = text;
					}
				}
				else
				{
					var selection = tinyMCE.getInstanceById(tinyMCE.getWindowArg('editor_id')).selection;
					var selected = selection.getSelectedHTML();
					var textarea = document.getElementById("latex_code");
					textarea.value = selected;
				}
				latexCodeChanged();
			}

			function initImage()
			{
				var inst = tinyMCE.getInstanceById(tinyMCE.getWindowArg('editor_id'));
				var elm = inst.getFocusElement();
				elm = tinyMCE.getParentElement(elm, "img");
				if (elm != null)
				{
					var id = elm.getAttribute("id");
					var src = elm.getAttribute("src");
					if (id == "latex")
					{
						var prefix = "{HREF_LATEX_CONVERTER}?";
						var latex_code = src.substr(prefix.length);
						var textarea = document.getElementById("latex_code");
						textarea.value = decodeURIComponent(latex_code);
					}
				}
			}
		</script>
		
	</head>
<body id="glossaryrefs" onload="tinyMCEPopup.executeOnLoad('init();');" style="display: none">
    <form onsubmit="insertAction();return false;" action="#">

		<div class="panel_glossary">
			<div id="general_panel" class="panel current">
				<fieldset>
					<legend>{$lang_latex_code_input}</legend>

					<table border="0" cellpadding="4" cellspacing="0">
						<tr>
							<td valign="top"><label id="latex_code_label" for="latex_code">{$lang_latex_latex_code}</label>:</td>
							<td valign="top">
								<textarea wrap="virtual" style="width:95%;" rows="10" cols="70" id="latex_code" name="latex_code" onchange="latexCodeChanged();">{LATEX_CODE}</textarea>
							</td>
						</tr>
						<tr>
							<td valign="top">{$lang_latex_preview}:</td>
							<td valign="top">
								<button type="button" name="createPreview" onclick="latexCodeChanged();">{$lang_latex_create_preview}</button>
								<p>
									<img id="preview" src="{URL_PREVIEW}" alt="{$lang_latex_preview}" />
								</p>
							</td>
						</tr>
					</table>
				</fieldset>
			</div>

		<div class="mceActionPanel">
			<div style="float: left">
				<input type="button" id="insert" name="insert" value="{$lang_insert}" onclick="insertAction();" />
			</div>

			<div style="float: right">
				<input type="button" id="cancel" name="cancel" value="{$lang_cancel}" onclick="tinyMCEPopup.close();" />
			</div>
		</div>
    </form>
</body>
</html>
